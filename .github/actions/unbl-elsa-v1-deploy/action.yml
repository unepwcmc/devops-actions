name: 'UNBL ELSA v1 Deploy'
description: 'Deploy UNBL ELSA services (ACR + container images + queueTrigger function app)'
author: 'WCMC DevOps Team'

inputs:
  environment:
    description: 'Deployment environment (staging, production)'
    required: true
  azure-credentials:
    description: 'Azure service principal credentials (JSON)'
    required: true
  name-prefix:
    description: 'Name prefix for resources (default: new-unbl-elsa)'
    required: false
    default: 'new-unbl-elsa'
  elsa-ref:
    description: 'Branch/tag to checkout from unbl-elsa'
    required: false
    default: 'new-staging-deploy'
  location:
    description: 'Azure region (e.g. uksouth)'
    required: false
    default: 'uksouth'
  build-elsa-r-image:
    description: 'Whether to build/push the ELSA R image'
    required: false
    default: 'true'
  build-trigger-image:
    description: 'Whether to build/push the ELSA trigger image'
    required: false
    default: 'true'

outputs:
  deployment-status:
    description: 'Status of the deployment operation'
    value: ${{ steps.deploy-result.outputs.status }}
  deployment-duration:
    description: 'Duration of the deployment operation in seconds'
    value: ${{ steps.deploy-result.outputs.duration }}
  resource-group:
    description: 'Resource group used for deployment'
    value: ${{ steps.deploy-result.outputs.resource_group }}

runs:
  using: 'composite'
  steps:
    - name: Start timing
      id: start
      shell: bash
      run: echo "start_time=$(date +%s)" >> "$GITHUB_OUTPUT"

    - name: Checkout ELSA repo
      uses: actions/checkout@v4
      with:
        repository: unepwcmc/unbl-elsa
        ref: ${{ inputs.elsa-ref }}
        path: ./unbl-elsa
        token: ${{ env.GH_TOKEN }}
        fetch-depth: 0

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ inputs.azure-credentials }}

    - name: Deploy ELSA 
      shell: bash
      run: |
        set -euo pipefail

        FLAGS=()
        if [ "${{ inputs.build-elsa-r-image }}" != "true" ]; then
          FLAGS+=( "--skip-elsa-r-image" )
        fi
        if [ "${{ inputs.build-trigger-image }}" != "true" ]; then
          FLAGS+=( "--skip-trigger-image" )
        fi

        chmod +x ./unbl-elsa/azure/scripts/deploy-elsa.sh
        ./unbl-elsa/azure/scripts/deploy-elsa.sh \
          --environment "${{ inputs.environment }}" \
          --location "${{ inputs.location }}" \
          "${FLAGS[@]}"

    - name: Logout of Azure
      shell: bash
      run: az logout || true

    - name: Set deployment result
      id: deploy-result
      shell: bash
      run: |
        set -euo pipefail
        END_TIME=$(date +%s)
        DURATION=$((END_TIME - ${{ steps.start.outputs.start_time }}))
        echo "status=success" >> "$GITHUB_OUTPUT"
        echo "duration=$DURATION" >> "$GITHUB_OUTPUT"
        # Resource group name is defined in the unbl-elsa parameters file.
        # Keep a stable output for callers without duplicating naming logic here.
        echo "resource_group=" >> "$GITHUB_OUTPUT"


