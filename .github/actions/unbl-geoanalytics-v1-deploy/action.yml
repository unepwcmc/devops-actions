name: 'UNBL Geoanalytics v1 Deploy'
description: 'Deploy UNBL geoanalytics services (shared infra + stacman/pretiler/exactextract) to Azure'
author: 'WCMC DevOps Team'

inputs:
  environment:
    description: 'Deployment environment (staging, production)'
    required: true
  azure-credentials:
    description: 'Azure service principal credentials (JSON)'
    required: true
  geoanalytics-ref:
    description: 'Branch/tag to checkout from unbl-geoanalytics'
    required: false
    default: 'new-staging-deploy'
  location:
    description: 'Azure region (e.g. uksouth)'
    required: false
    default: 'uksouth'
  deploy-shared-infra:
    description: 'Deploy shared resources (storage + ACR + container environment)'
    required: false
    default: 'true'
  deploy-stacman:
    description: 'Deploy stacman service'
    required: false
    default: 'true'
  deploy-pretiler:
    description: 'Deploy pretiler service'
    required: false
    default: 'true'
  deploy-exactextract:
    description: 'Deploy exactextract service'
    required: false
    default: 'true'

outputs:
  deployment-status:
    description: 'Status of the deployment operation'
    value: ${{ steps.deploy-result.outputs.status }}
  deployment-duration:
    description: 'Duration of the deployment operation in seconds'
    value: ${{ steps.deploy-result.outputs.duration }}
  resource-group:
    description: 'Resource group used for deployment'
    value: ${{ steps.deploy-result.outputs.resource_group }}
  container-registry:
    description: 'ACR name used for deployment'
    value: ${{ steps.deploy-result.outputs.acr_name }}

runs:
  using: 'composite'
  steps:
    - name: Start timing
      id: start
      shell: bash
      run: echo "start_time=$(date +%s)" >> "$GITHUB_OUTPUT"

    - name: Checkout geoanalytics repo
      uses: actions/checkout@v4
      with:
        repository: unepwcmc/unbl-geoanalytics
        ref: ${{ inputs.geoanalytics-ref }}
        path: ./unbl-geoanalytics
        token: ${{ env.GH_TOKEN }}

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ inputs.azure-credentials }}

    - name: Deploy geoanalytics (via repo script)
      shell: bash
      run: |
        set -euo pipefail

        FLAGS=()
        # Infra deploy toggle
        if [ "${{ inputs.deploy-shared-infra }}" != "true" ]; then
          FLAGS+=( "--skip-infra" )
        fi

        # Service toggles
        if [ "${{ inputs.deploy-stacman }}" != "true" ] && [ "${{ inputs.deploy-pretiler }}" != "true" ] && [ "${{ inputs.deploy-exactextract }}" != "true" ]; then
          # Nothing to deploy; still allow infra-only runs
          FLAGS+=( "--skip-apps" )
        else
          if [ "${{ inputs.deploy-stacman }}" != "true" ] && [ "${{ inputs.deploy-pretiler }}" != "true" ]; then
            FLAGS+=( "--only-exactextract" )
          elif [ "${{ inputs.deploy-stacman }}" != "true" ] && [ "${{ inputs.deploy-exactextract }}" != "true" ]; then
            FLAGS+=( "--only-pretiler" )
          elif [ "${{ inputs.deploy-pretiler }}" != "true" ] && [ "${{ inputs.deploy-exactextract }}" != "true" ]; then
            FLAGS+=( "--only-stacman" )
          fi
        fi

        chmod +x ./unbl-geoanalytics/azure/scripts/deploy-geoanalytics.sh
        ./unbl-geoanalytics/azure/scripts/deploy-geoanalytics.sh \
          --environment "${{ inputs.environment }}" \
          --location "${{ inputs.location }}" \
          "${FLAGS[@]}"

    - name: Logout of Azure
      shell: bash
      run: az logout || true

    - name: Set deployment result
      id: deploy-result
      shell: bash
      run: |
        set -euo pipefail
        END_TIME=$(date +%s)
        DURATION=$((END_TIME - ${{ steps.start.outputs.start_time }}))
        echo "status=success" >> "$GITHUB_OUTPUT"
        echo "duration=$DURATION" >> "$GITHUB_OUTPUT"
        echo "resource_group=${{ steps.names.outputs.rg }}" >> "$GITHUB_OUTPUT"
        echo "acr_name=${{ steps.names.outputs.acr }}" >> "$GITHUB_OUTPUT"


