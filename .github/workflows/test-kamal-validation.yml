name: Test Kamal Actions (Validation Only)

on:
  workflow_dispatch:
    inputs:
      kamal_version:
        description: 'Kamal version to test'
        required: true
        type: choice
        options:
        - v1
        - v2
      app_type:
        description: 'Application type to test'
        required: true
        type: choice
        options:
        - backend
        - frontend

jobs:
  validate-action-structure:
    name: Validate Kamal ${{ inputs.kamal_version }} ${{ inputs.app_type }} Actions (Full Test)
    runs-on: self-hosted
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.1.2
          bundler-cache: false

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.12.0"

      - name: Install Dependencies
        shell: bash
        run: |
          echo "ğŸ“¦ Installing required dependencies..."
          
          # Install PyYAML using system package manager (most reliable for runners)
          echo "ğŸ Installing PyYAML via system package manager..."
          if command -v apt-get &> /dev/null; then
            echo "ğŸ“¦ Using apt-get (Ubuntu/Debian)..."
            sudo apt-get update
            sudo apt-get install -y python3-yaml file
            echo "âœ… Installed python3-yaml and file via apt-get"
          elif command -v yum &> /dev/null; then
            echo "ğŸ“¦ Using yum (RHEL/CentOS)..."
            sudo yum install -y python3-PyYAML file
            echo "âœ… Installed python3-PyYAML and file via yum"
          elif command -v dnf &> /dev/null; then
            echo "ğŸ“¦ Using dnf (Fedora)..."
            sudo dnf install -y python3-PyYAML file
            echo "âœ… Installed python3-PyYAML and file via dnf"
          elif command -v brew &> /dev/null; then
            echo "ğŸ“¦ Using brew (macOS)..."
            brew install libyaml
            echo "âœ… Installed libyaml via brew"
          else
            echo "âŒ No supported package manager found"
            echo "ğŸ” Available commands:"
            which apt-get yum dnf brew 2>/dev/null || echo "None found"
            exit 1
          fi
          
          # Verify PyYAML installation
          echo "ğŸ” Verifying PyYAML installation..."
          if python3 -c "import yaml; print('âœ… PyYAML successfully imported'); print(f'PyYAML version: {yaml.__version__}')" 2>/dev/null; then
            echo "âœ… PyYAML installation verified and working"
          else
            echo "âŒ PyYAML installation failed or not working"
            echo "ğŸ” Python version: $(python3 --version)"
            echo "ğŸ” Python executable: $(which python3)"
            echo "ğŸ” Python module search paths:"
            python3 -c "import sys; print('\\n'.join(sys.path))" 2>/dev/null || echo "Could not get sys.path"
            echo "ğŸ” Available Python modules:"
            python3 -c "help('modules')" 2>/dev/null | head -20 || echo "Could not list modules"
            exit 1
          fi
          
          # Verify file command
          if command -v file &> /dev/null; then
            echo "âœ… file command available: $(file --version | head -1)"
          else
            echo "âš ï¸ file command not available (will skip file type detection)"
          fi
          
          echo "ğŸ‰ All dependencies ready!"

      - name: Validate Action Files
        shell: bash
        run: |
          echo "ğŸ” Validating Kamal ${{ inputs.kamal_version }} ${{ inputs.app_type }} action files..."
          
          if [[ "${{ inputs.app_type }}" == "backend" ]]; then
            setup_action=".github/actions/kamal-${{ inputs.kamal_version }}-setup/action.yml"
            deploy_action=".github/actions/kamal-${{ inputs.kamal_version }}-deploy/action.yml"
          else
            setup_action=".github/actions/nuxt-kamal-${{ inputs.kamal_version }}-setup/action.yml"
            deploy_action=".github/actions/nuxt-kamal-${{ inputs.kamal_version }}-deploy/action.yml"
          fi
          
          echo "ğŸ“‹ Checking setup action: $setup_action"
          if [[ -f "$setup_action" ]]; then
            echo "âœ… Setup action file exists"
            
            # Check environment info for debugging
            echo "ğŸ” Environment info:"
            echo "  Python version: $(python3 --version)"
            echo "  Locale: ${LANG:-none} ${LC_ALL:-none}"
            if command -v file &> /dev/null; then
              echo "  File encoding: $(file "$setup_action")"
            else
              echo "  File encoding: file command not available"
            fi
            
            # Validate YAML syntax with detailed error reporting
            echo "ğŸ” Validating YAML syntax..."
            python3 -c "import yaml; import sys; content = open('$setup_action', 'r', encoding='utf-8').read(); yaml.safe_load(content); print('âœ… Setup action YAML is valid')" 2>&1 || (echo "âŒ Setup action YAML validation failed" && exit 1)
            
            # Check for required fields
            if grep -q "name:" "$setup_action" && grep -q "description:" "$setup_action" && grep -q "runs:" "$setup_action"; then
              echo "âœ… Setup action has required metadata"
            else
              echo "âŒ Setup action missing required metadata"
              exit 1
            fi
            
          else
            echo "âŒ Setup action file not found"
            exit 1
          fi
          
          echo "ğŸ“‹ Checking deploy action: $deploy_action"
          if [[ -f "$deploy_action" ]]; then
            echo "âœ… Deploy action file exists"
            
            # Validate YAML syntax with detailed error reporting
            echo "ğŸ” Validating YAML syntax..."
            python3 -c "import yaml; import sys; content = open('$deploy_action', 'r', encoding='utf-8').read(); yaml.safe_load(content); print('âœ… Deploy action YAML is valid')" 2>&1 || (echo "âŒ Deploy action YAML validation failed" && exit 1)
            
            # Check for required fields
            if grep -q "name:" "$deploy_action" && grep -q "description:" "$deploy_action" && grep -q "runs:" "$deploy_action"; then
              echo "âœ… Deploy action has required metadata"
            else
              echo "âŒ Deploy action missing required metadata"
              exit 1
            fi
            
          else
            echo "âŒ Deploy action file not found"
            exit 1
          fi
          
          echo "ğŸ‰ Action file validation completed!"

      - name: Check Required Tools Availability
        shell: bash
        run: |
          echo "ğŸ”§ Checking required tools on runner..."
          
          tools_available=true
          
          # Check Ruby
          if command -v ruby &> /dev/null; then
            echo "âœ… Ruby: $(ruby --version)"
          else
            echo "âŒ Ruby not available"
            tools_available=false
          fi
          
          # Check Node.js
          if command -v node &> /dev/null; then
            echo "âœ… Node.js: $(node --version)"
          else
            echo "âŒ Node.js not available"
            tools_available=false
          fi
          
          # Check Docker
          if command -v docker &> /dev/null; then
            echo "âœ… Docker: $(docker --version)"
          else
            echo "âŒ Docker not available"
            tools_available=false
          fi
          
          # Check if we can install gems
          if command -v gem &> /dev/null; then
            echo "âœ… Gem command available"
          else
            echo "âŒ Gem command not available"
            tools_available=false
          fi
          
          # Check if we have access to install kamal
          if gem list kamal | grep -q kamal || echo "Testing gem install simulation"; then
            echo "âœ… Can test Kamal installation"
          else
            echo "âŒ Cannot test Kamal installation"
          fi
          
          if [[ "$tools_available" == "true" ]]; then
            echo "ğŸ‰ All required tools are available"
          else
            echo "âš ï¸  Some tools are missing, but validation can continue"
          fi

      - name: Test Kamal Installation
        shell: bash
        run: |
          echo "ğŸ’ Installing and testing Kamal..."
          
          # Verify Ruby and gem are available (should be from setup step)
          echo "ğŸ” Verifying Ruby environment:"
          echo "  Ruby version: $(ruby --version)"
          echo "  Gem version: $(gem --version)"
          echo "  Gem environment: $(gem env | grep 'RUBY EXECUTABLE' | head -1)"
          
          # Try to install kamal (or check if already installed)
          if command -v kamal &> /dev/null; then
            echo "âœ… Kamal already installed: $(kamal version)"
          else
            echo "ğŸ“¦ Installing Kamal ${{ inputs.kamal_version == 'v1' && '1.8.2' || '2.5.3' }}..."
            
            # Install the specific version
            if [[ "${{ inputs.kamal_version }}" == "v1" ]]; then
              kamal_version="1.8.2"
            else
              kamal_version="2.5.3"
            fi
            
            # Install Kamal
            echo "ğŸ”„ Running: gem install kamal --version $kamal_version --no-document"
            if gem install kamal --version "$kamal_version" --no-document; then
              echo "âœ… Kamal $kamal_version installed successfully"
              
              # Verify installation
              if command -v kamal &> /dev/null; then
                echo "ğŸ“‹ Kamal version: $(kamal version)"
                echo "ğŸ“š Kamal help (first 5 lines):"
                kamal help | head -5
                echo "âœ… Kamal is fully functional"
              else
                echo "âŒ Kamal installed but not available in PATH"
                exit 1
              fi
            else
              echo "âŒ Failed to install Kamal $kamal_version"
              echo "ğŸ” Gem installation details:"
              gem list | grep kamal || echo "No kamal gems found"
              echo "ğŸ” Gem paths:"
              gem env | grep -E "(GEM PATHS|EXECUTABLE DIRECTORY)"
              exit 1
            fi
          fi
          
          echo "ğŸ‰ Kamal installation and verification completed successfully"

      - name: Create Test Configuration
        shell: bash
        run: |
          echo "ğŸ“ Creating test configuration files..."
          
          # Create test directories
          mkdir -p config test-project
          cd test-project
          
          # Create a basic deploy.yml for testing
          if [[ "${{ inputs.app_type }}" == "backend" ]]; then
            cat > config/deploy.yml << 'EOF'
          service: test-rails-app
          image: test-rails-app
          
          servers:
            web:
              - 192.168.1.100
          
          registry:
            server: ghcr.io
            username: test-user
            password:
              - KAMAL_REGISTRY_PASSWORD
          
          env:
            clear:
              DATABASE_URL: postgresql://user:pass@localhost:5432/test_db
              RAILS_MASTER_KEY: fake-master-key-for-testing
              RAILS_ENV: staging
          EOF
          else
            cat > config/deploy.yml << 'EOF'
          service: test-nuxt-app
          image: test-nuxt-app
          
          servers:
            web:
              - 192.168.1.100
          
          registry:
            server: ghcr.io
            username: test-user
            password:
              - KAMAL_REGISTRY_PASSWORD
          
          env:
            clear:
              NUXT_PUBLIC_API_BASE_URL: https://api.test.example.com
              NODE_ENV: production
          EOF
          fi
          
          # Create a basic Dockerfile
          cat > Dockerfile << 'EOF'
          FROM node:18-alpine
          WORKDIR /app
          COPY package*.json ./
          RUN npm install
          COPY . .
          EXPOSE 3000
          CMD ["npm", "start"]
          EOF
          
          echo "âœ… Test configuration files created"

      - name: Test Kamal Configuration Validation
        shell: bash
        working-directory: test-project
        run: |
          echo "ğŸ§ª Testing Kamal configuration validation..."
          
          # Test config validation without actually connecting
          if kamal config validate; then
            echo "âœ… Kamal config validation passed"
          else
            echo "â„¹ï¸  Kamal config validation failed (expected with test config)"
            echo "ğŸ“‹ This is normal for test configurations with fake servers"
          fi
          
          # Test other kamal commands that don't require server access
          echo "ğŸ“š Available Kamal commands:"
          kamal help
          
          echo "ğŸ”§ Kamal version info:"
          kamal version
          
          echo "ğŸ‰ Configuration testing completed!"

      - name: Cleanup Test Files
        if: always()
        shell: bash
        run: |
          echo "ğŸ§¹ Cleaning up test files..."
          rm -rf test-project
          echo "âœ… Cleanup completed"

  test-action-inputs:
    name: Test Action Input Validation
    runs-on: self-hosted
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Test Action Input Validation
        shell: bash
        run: |
          echo "ğŸ§ª Testing action input validation..."
          
          # Determine which action to test
          if [[ "${{ inputs.app_type }}" == "backend" ]]; then
            action_file=".github/actions/kamal-${{ inputs.kamal_version }}-setup/action.yml"
          else
            action_file=".github/actions/nuxt-kamal-${{ inputs.kamal_version }}-setup/action.yml"
          fi
          
          echo "ğŸ” Testing action: $action_file"
          
          # Check if file exists
          if [[ ! -f "$action_file" ]]; then
            echo "âŒ Action file not found: $action_file"
            exit 1
          fi
          
          echo "âœ… Action file exists"
          
          # Basic YAML syntax check using yq (if available) or grep patterns
          if command -v yq &> /dev/null; then
            if yq eval . "$action_file" > /dev/null 2>&1; then
              echo "âœ… Action YAML syntax is valid"
            else
              echo "âŒ Action YAML syntax is invalid"
              exit 1
            fi
          else
            echo "âš ï¸  yq not available, using basic validation"
          fi
          
          # Check for required metadata fields
          if grep -q "^name:" "$action_file" && \
             grep -q "^description:" "$action_file" && \
             grep -q "^inputs:" "$action_file" && \
             grep -q "^runs:" "$action_file"; then
            echo "âœ… Action has required metadata fields"
          else
            echo "âŒ Action missing required metadata fields"
            exit 1
          fi
          
          # Check action name and description
          action_name=$(grep "^name:" "$action_file" | cut -d':' -f2- | xargs)
          action_desc=$(grep "^description:" "$action_file" | cut -d':' -f2- | xargs)
          
          echo "âœ… Action name: $action_name"
          echo "âœ… Action description: $action_desc"
          
          # Count inputs
          input_count=$(grep -A 1000 "^inputs:" "$action_file" | grep -B 1000 "^runs:" | grep -c "^  [a-z].*:" || echo "0")
          echo "ğŸ“‹ Found $input_count input parameters"
          
          # Check for recommended inputs
          recommended_inputs=("kamal-version" "ruby-version" "ssh-private-key")
          found_inputs=()
          missing_inputs=()
          
          for input in "${recommended_inputs[@]}"; do
            if grep -q "  $input:" "$action_file"; then
              found_inputs+=("$input")
            else
              missing_inputs+=("$input")
            fi
          done
          
          if [[ ${#found_inputs[@]} -gt 0 ]]; then
            echo "âœ… Found recommended inputs: ${found_inputs[*]}"
          fi
          
          if [[ ${#missing_inputs[@]} -gt 0 ]]; then
            echo "âš ï¸  Missing recommended inputs: ${missing_inputs[*]}"
          fi
          
          # Check for composite action
          if grep -q "using: 'composite'" "$action_file" || grep -q "using: composite" "$action_file"; then
            echo "âœ… Uses composite action format"
          else
            echo "âš ï¸  Does not use composite action format"
          fi
          
          # Count steps
          step_count=$(grep -A 1000 "^  steps:" "$action_file" | grep -c "^    - name:" || echo "0")
          if [[ $step_count -ge 3 ]]; then
            echo "âœ… Has $step_count steps"
          else
            echo "âš ï¸  Only $step_count steps found, expected more for setup action"
          fi
          
          # Check for input validation
          if grep -A 1000 "^  steps:" "$action_file" | grep -i "validate.*input" > /dev/null; then
            echo "âœ… Contains input validation logic"
          else
            echo "âš ï¸  No obvious input validation found"
          fi
          
          echo "ğŸ‰ Action input validation completed!"

  test-summary:
    needs: [validate-action-structure, test-action-inputs]
    if: always()
    name: Test Summary
    runs-on: self-hosted
    
    steps:
      - name: Display Test Results
        run: |
          echo "## ğŸ§ª Kamal ${{ inputs.kamal_version }} ${{ inputs.app_type }} Validation Summary"
          echo ""
          echo "### Test Results:"
          
          if [[ "${{ needs.validate-action-structure.result }}" == "success" ]]; then
            echo "âœ… Action Structure Validation: PASSED"
          else
            echo "âŒ Action Structure Validation: FAILED"
          fi
          
          if [[ "${{ needs.test-action-inputs.result }}" == "success" ]]; then
            echo "âœ… Input Validation: PASSED"
          else
            echo "âŒ Input Validation: FAILED"
          fi
          
          echo ""
          echo "### Next Steps:"
          echo "1. âœ… Actions are structurally valid"
          echo "2. ğŸš€ Ready for integration testing with real credentials"
          echo "3. ğŸ“‹ Test in consumer repository with staging environment"
          
          # Fail if any tests failed
          if [[ "${{ needs.validate-action-structure.result }}" == "failure" ]] || [[ "${{ needs.test-action-inputs.result }}" == "failure" ]]; then
            echo "âŒ Some validation tests failed!"
            exit 1
          fi
          
          echo "ğŸ‰ All validation tests passed! Actions are ready for use." 